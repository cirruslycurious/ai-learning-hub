name: CI/CD Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"

jobs:
  # Stage 1: Lint & Format
  lint-and-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run format check
        run: npm run format:check

      - name: Run lint
        run: npm run lint

  # Stage 2: Type Check
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: [lint-and-format]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

  # Stage 3: Unit Tests with Coverage Gate
  unit-tests:
    name: Unit Tests (80% Coverage Gate)
    runs-on: ubuntu-latest
    needs: [type-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # Stage 4: CDK Synth & CDK Nag
  cdk-synth:
    name: CDK Synth & CDK Nag
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Infrastructure
        working-directory: ./infra
        run: npm run build

      - name: CDK Synth with CDK Nag
        working-directory: ./infra
        run: |
          # CDK Nag runs during synth via Aspects in app.ts
          # Error-level findings will fail synth automatically (exit code)
          npx cdk synth 2>&1 | tee synth-output.log
          CDK_EXIT_CODE=${PIPESTATUS[0]}

          # Check if no stacks defined (exit code 1 is expected in this case)
          if grep -q "This app contains no stacks" synth-output.log; then
            echo "‚ÑπÔ∏è No stacks defined yet - CDK Nag will run when stacks are added"
            exit 0
          fi

          # Verify CDK Nag ran by checking for its output
          if grep -q "AwsSolutions" synth-output.log || grep -q "cdk-nag" synth-output.log; then
            echo "‚úÖ CDK Nag checks executed successfully"
          else
            echo "‚ùå CDK Nag did not run but stacks exist - check configuration"
            exit 1
          fi

          # Check CDK synth exit code (CDK Nag errors will fail synth)
          if [ $CDK_EXIT_CODE -ne 0 ]; then
            echo "‚ùå CDK synth failed (possibly due to CDK Nag findings)"
            exit $CDK_EXIT_CODE
          fi

  # Stage 5: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [cdk-synth]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: |
          # Placeholder for integration tests
          # Will be implemented as integration test suite grows
          echo "‚úÖ Integration tests placeholder - ready for implementation"

  # Stage 6: Contract Tests
  contract-tests:
    name: Contract Tests (OpenAPI)
    runs-on: ubuntu-latest
    needs: [integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run contract tests
        run: |
          # Placeholder for contract tests
          # Will validate API contracts against OpenAPI spec when spec is ready
          echo "‚úÖ Contract tests placeholder - awaiting OpenAPI spec"

  # Stage 7: Agent-Specific Security Scanning
  security-scan:
    name: Security Scanning (Agent-Enhanced)
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Dependency Vulnerability Scan (npm audit)
        run: |
          # Fail on high/critical vulnerabilities in production dependencies
          npm audit --audit-level=high --omit=dev
          echo "‚úÖ No high or critical vulnerabilities found in production dependencies"

      - name: Secrets Detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: SAST with ESLint Security Plugin
        run: |
          # Note: Lint runs here again for SAST context (security rules + custom import guards)
          # First run (lint-and-format job) validates code style/quality
          # This run provides security-focused context for audit trail
          npm run lint
          echo "‚úÖ SAST checks completed via ESLint"

      - name: Agent Code Security Notice
        run: |
          echo "ü§ñ Agent-Generated Code Security Notice (FR79)"
          echo "Per PRD, AI-assisted code has 3x vulnerability rate"
          echo "All findings above should be reviewed with extra scrutiny"
          echo "Security thresholds configured accordingly"

  # Stage 8: Deploy to Dev (Conditional)
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [contract-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate AWS Credentials Configured
        run: |
          if [ -z "${{ secrets.AWS_ROLE_ARN }}" ]; then
            echo "‚ùå AWS_ROLE_ARN secret not configured"
            echo "‚ÑπÔ∏è Deploying to main branch requires AWS credentials"
            echo "‚ÑπÔ∏è Configure AWS_ROLE_ARN secret with OIDC role ARN"
            echo "‚ÑπÔ∏è See: https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services"
            exit 1
          fi
          echo "‚úÖ AWS credentials configuration validated"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-2

      - name: Deploy Infrastructure
        working-directory: ./infra
        run: |
          echo "üöÄ Deploying to Dev environment"
          npx cdk deploy --all --require-approval never

  # Stage 9: E2E Tests (6 Persona Paths)
  e2e-tests:
    name: E2E Tests (6 Persona Paths)
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run E2E tests
        run: |
          echo "üß™ E2E Test Placeholder - 6 Persona Golden Paths"
          echo ""
          echo "Planned persona paths:"
          echo "  1. New User Onboarding (signup ‚Üí first save ‚Üí first project)"
          echo "  2. Mobile Quick Save (iOS Shortcut capture)"
          echo "  3. Resource Discovery (search ‚Üí filter ‚Üí view)"
          echo "  4. Project Builder (create project ‚Üí link resources ‚Üí notes)"
          echo "  5. Tutorial Learner (mark tutorial ‚Üí track progress ‚Üí complete)"
          echo "  6. Power User (API key ‚Üí programmatic saves ‚Üí bulk operations)"
          echo ""
          echo "‚úÖ E2E placeholder ready - tests will run against deployed dev environment"

  # Stage 10: Deploy to Prod (Manual Approval)
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://ai-learning-hub.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate AWS Credentials Configured
        run: |
          if [ -z "${{ secrets.AWS_ROLE_ARN_PROD }}" ]; then
            echo "‚ùå AWS_ROLE_ARN_PROD secret not configured"
            echo "‚ÑπÔ∏è Production deployment requires AWS credentials"
            echo "‚ÑπÔ∏è Configure AWS_ROLE_ARN_PROD secret with OIDC role ARN"
            echo "‚ÑπÔ∏è See: https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services"
            exit 1
          fi
          echo "‚úÖ AWS credentials configuration validated"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: us-east-2

      - name: Deploy to Production
        working-directory: ./infra
        run: |
          echo "üöÄ Deploying to Production environment"
          npx cdk deploy --all --require-approval never
