---
id: "2.1-D7"
title: "Adversarial Architecture Review Fixes"
status: ready-for-dev
depends_on: ["2.1-D5"]
touches:
  - infra/test/architecture-enforcement
  - infra/test/helpers
  - infra/lib/stacks/api
  - infra/lib/stacks/auth
  - backend/shared/types/src/errors.ts
  - backend/shared/middleware/src/wrapper.ts
  - backend/shared/middleware/package.json
  - backend/shared/db/src/users.ts
  - backend/shared/db/src/invite-codes.ts
  - backend/shared/types/src/entities.ts
  - backend/functions/api-keys
  - backend/functions/invite-codes
  - backend/functions/users-me
  - frontend/src/api
  - frontend/vite.config.ts
risk: medium
---

# Story 2.1.D7: Adversarial Architecture Review Fixes

## Story

As a developer about to build Epic 3 saves endpoints and future frontend features,
I want the 15 findings from the adversarial architecture review (2026-02-20) fixed — covering architecture enforcement test blind spots, ADR-008 contract gaps, request logging, configuration discipline, handler test coverage, type alignment, and frontend API foundations,
so that the project's structural soundness moves from 7/10 to 9/10 and Epics 3+ build on a genuinely robust base rather than accumulating debt.

## Context & Motivation

An adversarial architecture review on 2026-02-20 (post D5/D6) identified 15 findings across 5 severity levels. The most critical: architecture enforcement tests (T1-T4) can detect _presence_ of handler wiring but not _correctness_ — a route pointing to the wrong Lambda would silently ship. Three handlers return 405 responses via hand-built JSON that bypasses ADR-008, the DB layer silently falls back to hardcoded table names, and the frontend has zero API integration infrastructure.

These findings are cataloged in `docs/adversarial-architecture-review-2026-02-20.md` with file paths, line numbers, and proposed fixes. This story specifies the implementation plan for all 15 fixes.

**Review findings addressed:** F1, F2, F3, F4, F5, F6, F7, F8, F9, F10, F11, F12, F13, F14, F15

## Acceptance Criteria

### Group A: Architecture Enforcement Hardening (F1, F3, F5)

1. **AC1** — Given the route registry maps `handlerRef` to a specific Lambda, when T2/T4 runs, then each route's `Integration.Uri` in the CDK template is validated against the _specific_ Lambda expected for that `handlerRef` — not just any Lambda. If `/users/me` is accidentally wired to `apiKeysFunction`, the test fails with a message identifying the mismatch.

2. **AC2** — Given the T2-AC6 and T4-AC10 orphan detection tests, when they run, then orphan detection works by parsing each Method's `Integration.Uri` to extract the Lambda function ARN reference (via `Fn::GetAtt` or `Fn::Join`), building a `handlerRef → Lambda ARN` map from CDK template resources, and verifying every handler ref in the registry appears in at least one method's integration — replacing the current unreliable cardinality comparison.

3. **AC3** — Given the T1-AC2 Gateway Response test, when it validates `UNAUTHORIZED`, `ACCESS_DENIED`, `THROTTLED`, `DEFAULT_5XX` responses, then it also verifies each `GatewayResponse` resource's `StatusCode` property matches the expected HTTP status for that response type (e.g., `THROTTLED` → `429`, `UNAUTHORIZED` → `401`).

### Group B: ADR-008 Contract — METHOD_NOT_ALLOWED (F13)

4. **AC4** — Given the `ErrorCode` enum in `backend/shared/types/src/errors.ts`, when the enum is inspected, then `METHOD_NOT_ALLOWED = "METHOD_NOT_ALLOWED"` exists as a member and `ErrorCodeToStatus` maps it to `405`.

5. **AC5** — Given the handlers `api-keys/handler.ts`, `invite-codes/handler.ts`, `users-me/handler.ts`, when an unsupported HTTP method is received, then the handler throws `new AppError(ErrorCode.METHOD_NOT_ALLOWED, ...)` with an `Allow` header in the details, and `wrapHandler` returns the response through `createErrorResponse` — replacing the current hand-built 405 JSON.

6. **AC6** — Given the updated 405 responses flow through `createErrorResponse`, when existing handler tests assert `METHOD_NOT_ALLOWED`, then `assertADR008Error(result, "METHOD_NOT_ALLOWED", 405)` passes and the `Allow` header is present in the response.

### Group C: Request Logging (F4)

7. **AC7** — Given `wrapHandler` in `backend/shared/middleware/src/wrapper.ts`, when a request is received, then the wrapper logs `"Request received"` with `{ method, path, queryParams }` immediately after logger creation and before auth extraction.

8. **AC8** — Given the new request-entry log line, when all existing handler tests run, then they continue to pass without modification (the log line is informational, not behavioral).

### Group D: Configuration Discipline (F14, F7, F12)

9. **AC9** — Given `USERS_TABLE_CONFIG` in `backend/shared/db/src/users.ts` and `INVITE_CODES_TABLE_CONFIG` in `backend/shared/db/src/invite-codes.ts`, when the `*_TABLE_NAME` env var is missing at runtime, then the module throws a clear error (`"USERS_TABLE_NAME environment variable is required"`) instead of silently falling back to a hardcoded name. Test environments may set `NODE_ENV=test` to use fallbacks.

10. **AC10** — Given `TablesStack` in `infra/lib/stacks/core/tables.stack.ts`, when it creates DynamoDB tables, then table names include an environment prefix (e.g., `dev-ai-learning-hub-users`). The prefix is passed as a stack prop from `bin/app.ts` and defaults to `"dev"`.

11. **AC11** — Given `ApiGatewayStack` in `infra/lib/stacks/api/api-gateway.stack.ts`, when it creates the REST API deployment, then `stageName` is a configurable stack prop that defaults to `"dev"` — not a hardcoded string literal.

### Group E: Handler Test Coverage (F8, F9)

12. **AC12** — Given handlers that call `enforceRateLimit()` before business logic (api-keys POST, invite-codes POST, validate-invite POST), when handler tests run, then at least one test per handler verifies the call ordering: `enforceRateLimit` is called before the business operation (e.g., `createApiKey`, `createInviteCode`).

13. **AC13** — Given handlers wrapped with `requiredScope` (api-keys POST/DELETE, invite-codes POST), when a handler test sends a request with `authMethod: "api-key"` and insufficient scopes, then the response is `403 SCOPE_INSUFFICIENT` via `assertADR008Error`.

### Group F: Type Alignment & Cleanup (F15, F6)

14. **AC14** — Given `InviteCode` in `backend/shared/types/src/entities.ts` and `InviteCodeItem` in `backend/shared/db/src/invite-codes.ts`, when field names are compared, then they use consistent terminology: the types package uses `generatedBy`/`redeemedBy` (matching the DB source of truth), not `createdBy`/`usedBy`.

15. **AC15** — Given `backend/shared/middleware/package.json`, when its dependencies are inspected, then `@ai-learning-hub/validation` is NOT listed (it was unused).

### Group G: IAM Least Privilege (F11)

16. **AC16** — Given the JWT and API Key authorizer Lambdas in `infra/lib/stacks/auth/auth.stack.ts`, when their IAM permissions are inspected, then they use explicit action grants (`dynamodb:GetItem`, `dynamodb:PutItem`, `dynamodb:UpdateItem`, `dynamodb:Query`) instead of `grantReadWriteData` (which includes `Scan`, `BatchGetItem`, `BatchWriteItem`).

### Group H: Frontend API Foundations (F2, F10)

17. **AC17** — Given a file `frontend/src/api/client.ts`, when it is imported, then it exports a typed `ApiClient` class or function that: (a) takes a base URL from `VITE_API_URL`, (b) provides `get<T>()`, `post<T>()`, `patch<T>()`, `delete()` methods that unwrap the `{ data: T }` envelope and return `Promise<T>` (throwing typed `AppError`-shaped errors on non-2xx), (c) accepts an auth token injection function.

18. **AC18** — Given a file `frontend/src/api/hooks.ts`, when `useApiClient()` is called inside a React component, then it returns an `ApiClient` instance configured with the current Clerk session token via `useAuth()`.

19. **AC19** — Given `frontend/vite.config.ts`, when Vite resolves `@ai-learning-hub/types`, then it resolves to the shared types package source (via `resolve.alias` or workspace dependency), and TypeScript compilation succeeds.

### Group I: Gate

20. **AC20** — All existing tests pass (`npm test`), CDK synth passes, no lint errors, and no regressions in coverage thresholds.

## Tasks / Subtasks

- [ ] **Task 1: Harden T2/T4 handler identity and orphan detection** (AC: #1, #2)
  - [ ] 1.1 In `infra/test/helpers/create-test-api-stacks.ts`, add an explicit `HANDLER_REF_TO_CONSTRUCT_ID` map (e.g., `{ validateInviteFunction: "ValidateInviteFunction", ... }`) and a helper `buildHandlerRefToLambdaArn(template)` that uses this map to find each handler's Lambda logical ID in the CDK template deterministically — do NOT use fuzzy substring matching on logical IDs
  - [ ] 1.2 In `route-completeness.test.ts` (T2-AC5), enhance the test so that for each route, the Method's `Integration.Uri` references the Lambda corresponding to the route's `handlerRef` — not just any Lambda
  - [ ] 1.3 In `route-completeness.test.ts` (T2-AC6), replace the cardinality comparison with a deterministic check: parse each Method's `Integration.Uri`, extract Lambda ARN references, and verify every `handlerRef` in the registry appears in at least one integration
  - [ ] 1.4 In `lambda-route-wiring.test.ts` (T4-AC9), replace the weak `uriStr.includes("lambda")` check with validation that the URI references a real Lambda function ARN from the template
  - [ ] 1.5 In `lambda-route-wiring.test.ts` (T4-AC10), apply the same deterministic orphan detection from 1.3
  - [ ] 1.6 Write a dedicated test case that creates a mis-wired test fixture (swapping `usersMeFunction` and `apiKeysFunction` in the test helper's stack setup) and asserts the handler identity test fails — do NOT modify production stacks; the miswiring must be isolated to a test-only fixture

- [ ] **Task 2: Add Gateway Response status code validation to T1** (AC: #3)
  - [ ] 2.1 In `api-gateway-contract.test.ts`, add a sub-test under AC2 that extracts `StatusCode` from each `AWS::ApiGateway::GatewayResponse` resource
  - [ ] 2.2 Assert each response type maps to the correct HTTP status: `UNAUTHORIZED` → `401`, `ACCESS_DENIED` → `403`, `THROTTLED` → `429`, `DEFAULT_5XX` → `500`

- [ ] **Task 3: Add METHOD_NOT_ALLOWED to ErrorCode enum** (AC: #4)
  - [ ] 3.1 Add `METHOD_NOT_ALLOWED = "METHOD_NOT_ALLOWED"` to the `ErrorCode` enum in `backend/shared/types/src/errors.ts`
  - [ ] 3.2 Add `[ErrorCode.METHOD_NOT_ALLOWED]: 405` to `ErrorCodeToStatus`
  - [ ] 3.3 Update `assertADR008Error` tests to cover the new error code

- [ ] **Task 4: Migrate handlers to use AppError for 405 responses** (AC: #5, #6)
  - [ ] 4.1 In `backend/functions/api-keys/handler.ts`, replace the hand-built 405 JSON (line ~130-138) with `throw new AppError(ErrorCode.METHOD_NOT_ALLOWED, "Method ${method} not allowed")` — handle the `Allow` header by adding it to `wrapHandler`'s response or via `error.details`
  - [ ] 4.2 In `backend/functions/invite-codes/handler.ts`, apply the same replacement (line ~100-110)
  - [ ] 4.3 In `backend/functions/users-me/handler.ts`, apply the same replacement (line ~85-95)
  - [ ] 4.4 Add a reserved `responseHeaders` key to `AppError.details` (separate from the serialized `details` in the response body). In `createErrorResponse`, extract `error.details.responseHeaders`, merge into HTTP headers, and strip it from the body's `details` object before serialization — this prevents transport metadata from leaking into the API response body
  - [ ] 4.5 Update handler tests to use `assertADR008Error(result, "METHOD_NOT_ALLOWED", 405)` and verify `Allow` header is present

- [ ] **Task 5: Add request-entry logging to wrapHandler** (AC: #7, #8)
  - [ ] 5.1 In `backend/shared/middleware/src/wrapper.ts`, add a `logger.info("Request received", { method: event.httpMethod, path: event.path, queryParams: Object.keys(event.queryStringParameters ?? {}) })` call after logger creation (line ~107) and before auth extraction (line ~111)
  - [ ] 5.2 Run all handler tests to verify no regressions

- [ ] **Task 6: Remove DB table name fallbacks — fail fast** (AC: #9)
  - [ ] 6.1 In `backend/shared/db/src/users.ts`, replace `process.env.USERS_TABLE_NAME ?? "ai-learning-hub-users"` with a function that throws if the env var is missing (unless `NODE_ENV === "test"`)
  - [ ] 6.2 In `backend/shared/db/src/invite-codes.ts`, apply the same pattern for `INVITE_CODES_TABLE_NAME`
  - [ ] 6.3 Check all other DB files (rate-limiter, helpers) for similar fallback patterns and fix
  - [ ] 6.4 Update DB unit tests to set `NODE_ENV=test` or set the env vars explicitly in `beforeAll` / `vi.stubEnv`
  - [ ] 6.5 Update handler tests that depend on DB modules to ensure env vars are set

- [ ] **Task 7: Add environment prefix to table names** (AC: #10)
  - [ ] 7.1 In `infra/lib/stacks/core/tables.stack.ts`, accept an `environmentPrefix` prop (default `"dev"`)
  - [ ] 7.2 Prepend the prefix to all table names (e.g., `${prefix}-ai-learning-hub-users`)
  - [ ] 7.3 Update `bin/app.ts` to pass the prefix from context or environment
  - [ ] 7.4 Update CDK tests that assert table names to account for the prefix
  - [ ] 7.5 Update Lambda environment variable injection in CDK stacks to pass the prefixed table names

- [ ] **Task 8: Parameterize API Gateway stage name** (AC: #11)
  - [ ] 8.1 In `infra/lib/stacks/api/api-gateway.stack.ts`, add `stageName` to the stack props interface with default `"dev"`
  - [ ] 8.2 Replace the hardcoded `"dev"` string with the prop value
  - [ ] 8.3 Update `bin/app.ts` to pass the stage name from context
  - [ ] 8.4 Update any CDK tests that reference the stage name

- [ ] **Task 9: Add rate-limit ordering tests** (AC: #12)
  - [ ] 9.1 In `backend/functions/api-keys/handler.test.ts`, add a test that verifies `enforceRateLimit` is called before `createApiKey` using call-order tracking
  - [ ] 9.2 In `backend/functions/invite-codes/handler.test.ts`, add a test that verifies `enforceRateLimit` is called before `createInviteCode`
  - [ ] 9.3 In `backend/functions/validate-invite/handler.test.ts`, add a test that verifies `enforceRateLimit` is called before `validateInviteCode`

- [ ] **Task 10: Add scope enforcement tests** (AC: #13)
  - [ ] 10.1 In `backend/functions/api-keys/handler.test.ts`, add a test: API key with `["saves:read"]` scope → POST /users/api-keys → `403 SCOPE_INSUFFICIENT`
  - [ ] 10.2 In `backend/functions/invite-codes/handler.test.ts`, add a test: API key with insufficient scope → POST /users/invite-codes → `403 SCOPE_INSUFFICIENT`
  - [ ] 10.3 Use `createMockEvent({ authMethod: "api-key", scopes: [...] })` and `assertADR008Error`

- [ ] **Task 11: Align InviteCode type fields** (AC: #14)
  - [ ] 11.1 In `backend/shared/types/src/entities.ts`, rename `InviteCode.createdBy` → `generatedBy` and `InviteCode.usedBy` → `redeemedBy`, `InviteCode.usedAt` → `redeemedAt`, `InviteCode.createdAt` → `generatedAt`
  - [ ] 11.2 Search for all consumers of `InviteCode.createdBy` and `InviteCode.usedBy` across the codebase and update references
  - [ ] 11.3 Verify TypeScript compilation succeeds across all workspaces

- [ ] **Task 12: Remove unused validation dependency from middleware** (AC: #15)
  - [ ] 12.1 Remove `"@ai-learning-hub/validation": "*"` from `backend/shared/middleware/package.json` dependencies
  - [ ] 12.2 Run `npm install` to update lockfile (this is an expected lockfile change — include it in the commit with a note in the PR)
  - [ ] 12.3 Verify middleware builds and tests pass

- [ ] **Task 13: Narrow authorizer Lambda IAM** (AC: #16)
  - [ ] 13.1 In `infra/lib/stacks/auth/auth.stack.ts`, replace `usersTable.grantReadWriteData(jwtAuthorizerFunction)` with explicit `addToRolePolicy` grants for `dynamodb:GetItem`, `dynamodb:PutItem`, `dynamodb:UpdateItem`, `dynamodb:Query`
  - [ ] 13.2 Apply the same narrowing for `apiKeyAuthorizerFunction`
  - [ ] 13.3 Include GSI ARN in the resource list for `dynamodb:Query` (needed for email/API key lookups)
  - [ ] 13.4 Verify CDK synth passes and the auth stack template has the narrower permissions

- [ ] **Task 14: Create frontend API client** (AC: #17, #18, #19)
  - [ ] 14.1 Create `frontend/src/api/client.ts` with typed `ApiClient` — `get<T>()`, `post<T>()`, `patch<T>()`, `delete()` methods, `VITE_API_URL` base, token injection callback
  - [ ] 14.2 Create `frontend/src/api/hooks.ts` with `useApiClient()` hook that uses Clerk's `useAuth()` to inject the session token
  - [ ] 14.3 Create `frontend/src/api/index.ts` barrel export
  - [ ] 14.4 In `frontend/vite.config.ts`, add `resolve.alias` for `@ai-learning-hub/types` pointing to `../backend/shared/types/src`
  - [ ] 14.5 In `frontend/tsconfig.json`, add path alias for `@ai-learning-hub/types`
  - [ ] 14.6 Create `frontend/.env.example` with `VITE_API_URL=http://localhost:3000/dev`
  - [ ] 14.7 Add basic unit tests for `ApiClient` in `frontend/src/api/client.test.ts` (mock fetch)

- [ ] **Task 15: Verify gate** (AC: #20)
  - [ ] 15.1 Run `npm test` across all workspaces — all tests must pass
  - [ ] 15.2 Run `npx tsc --noEmit` across all workspaces — no type errors
  - [ ] 15.3 Run `npm run lint` — no lint errors
  - [ ] 15.4 Run `cd infra && cdk synth` — must complete without errors
  - [ ] 15.5 Verify coverage thresholds still met (80%+ across all packages)

## Dev Notes

### Task Ordering Recommendation

The 15 tasks can be grouped into independent work tracks:

**Track 1 (backend core — do first):**
Tasks 3 → 4 → 5 → 6 (ErrorCode → handlers → wrapper → DB config)
These have sequential dependencies: Task 4 depends on Task 3, etc.

**Track 2 (infra):**
Tasks 1, 2, 7, 8, 13 (test hardening + CDK changes)
These are independent of Track 1 but must be done before Task 15.

**Track 3 (test coverage):**
Tasks 9, 10 (handler test additions)
Depends on Task 4 being done (405 changes) but otherwise independent.

**Track 4 (cleanup):**
Tasks 11, 12 (type alignment, dep removal)
Independent; can be done anytime.

**Track 5 (frontend):**
Task 14 (API client foundations)
Independent of all backend changes.

### Architecture Patterns to Follow

**Adding a custom header to AppError responses (Task 4):**

Use a reserved `responseHeaders` key in `error.details` — extracted by `createErrorResponse` into HTTP headers and stripped before body serialization:
```typescript
// In error-handler.ts:
export function createErrorResponse(error: AppError, requestId: string): APIGatewayProxyResult {
  const headers: Record<string, string> = {
    "Content-Type": "application/json",
    "X-Request-Id": requestId,
  };

  // Extract transport-only headers from details (strip before body serialization)
  const { responseHeaders, ...bodyDetails } = error.details ?? {};
  if (responseHeaders && typeof responseHeaders === "object") {
    Object.assign(headers, responseHeaders);
  }

  // ... existing Retry-After logic ...

  // Use bodyDetails (without responseHeaders) for the serialized body
  const body = error.toApiError(requestId);
  if (body.error.details) {
    const { responseHeaders: _, ...clean } = body.error.details;
    body.error.details = Object.keys(clean).length > 0 ? clean : undefined;
  }

  return { statusCode: error.statusCode, headers, body: JSON.stringify(body) };
}

// In handler — clean, no transport metadata leaks into body:
throw new AppError(ErrorCode.METHOD_NOT_ALLOWED, `Method ${method} not allowed`, {
  responseHeaders: { Allow: "GET, PATCH" },
});
```

**Fail-fast table config pattern (Task 6):**
```typescript
function requireEnv(name: string, testFallback?: string): string {
  const value = process.env[name];
  if (value) return value;
  if (process.env.NODE_ENV === "test" && testFallback) return testFallback;
  throw new Error(`${name} environment variable is required`);
}

export const USERS_TABLE_CONFIG: TableConfig = {
  tableName: requireEnv("USERS_TABLE_NAME", "ai-learning-hub-users"),
  partitionKey: "PK",
  sortKey: "SK",
};
```

**Handler identity verification pattern (Task 1):**
```typescript
// Explicit mapping — DO NOT use fuzzy substring matching on CDK logical IDs.
// CDK appends hash suffixes to logical IDs and may change them across versions.
// This map is the single source of truth for which construct ID corresponds to
// which handlerRef in the route registry.
const HANDLER_REF_TO_CONSTRUCT_ID: Record<string, string> = {
  validateInviteFunction: "ValidateInviteFunction",
  usersMeFunction: "UsersMeFunction",
  apiKeysFunction: "ApiKeysFunction",
  generateInviteFunction: "GenerateInviteFunction",
};

function buildHandlerRefToLambdaArn(
  template: Template
): Map<string, string> {
  const functions = template.findResources("AWS::Lambda::Function");
  const map = new Map<string, string>();

  for (const [handlerRef, constructId] of Object.entries(HANDLER_REF_TO_CONSTRUCT_ID)) {
    // Find the logical ID that starts with the construct ID (CDK appends a hash)
    const logicalId = Object.keys(functions).find((id) =>
      id.startsWith(constructId)
    );
    if (!logicalId) {
      throw new Error(`No Lambda found for handlerRef "${handlerRef}" (expected construct ID prefix "${constructId}")`);
    }
    map.set(handlerRef, logicalId);
  }

  return map;
}
```

**Rate-limit ordering test pattern (Task 9):**
```typescript
it("enforces rate limit before creating API key", async () => {
  const callOrder: string[] = [];
  mockEnforceRateLimit.mockImplementation(async () => {
    callOrder.push("rateLimit");
  });
  mockCreateApiKey.mockImplementation(async () => {
    callOrder.push("createApiKey");
    return mockApiKeyResult;
  });

  const event = createMockEvent({ method: "POST", path: "/users/api-keys", ... });
  await handler(event, mockContext);

  expect(callOrder).toEqual(["rateLimit", "createApiKey"]);
});
```

### Key Files Reference

**Files to modify:**
```
backend/shared/types/src/errors.ts              (add METHOD_NOT_ALLOWED)
backend/shared/types/src/entities.ts            (rename InviteCode fields)
backend/shared/middleware/src/wrapper.ts         (add request-entry log)
backend/shared/middleware/src/error-handler.ts   (optional: details.headers support)
backend/shared/middleware/package.json           (remove validation dep)
backend/shared/db/src/users.ts                   (fail-fast env var)
backend/shared/db/src/invite-codes.ts            (fail-fast env var)
backend/functions/api-keys/handler.ts            (AppError for 405)
backend/functions/api-keys/handler.test.ts       (ordering + scope + 405 tests)
backend/functions/invite-codes/handler.ts        (AppError for 405)
backend/functions/invite-codes/handler.test.ts   (ordering + scope + 405 tests)
backend/functions/users-me/handler.ts            (AppError for 405)
backend/functions/users-me/handler.test.ts       (405 test update)
infra/test/architecture-enforcement/route-completeness.test.ts  (handler identity, orphan fix)
infra/test/architecture-enforcement/lambda-route-wiring.test.ts (URI validation, orphan fix)
infra/test/architecture-enforcement/api-gateway-contract.test.ts (status code validation)
infra/test/helpers/create-test-api-stacks.ts     (handler map helper)
infra/lib/stacks/core/tables.stack.ts            (env prefix)
infra/lib/stacks/api/api-gateway.stack.ts        (stageName prop)
infra/lib/stacks/auth/auth.stack.ts              (narrow IAM)
infra/bin/app.ts                                  (pass prefix, stageName)
```

**Files to create:**
```
frontend/src/api/client.ts       (typed API client)
frontend/src/api/hooks.ts        (useApiClient hook)
frontend/src/api/index.ts        (barrel export)
frontend/src/api/client.test.ts  (unit tests)
frontend/.env.example            (VITE_API_URL)
```

**Files that MUST NOT be modified:**
```
infra/config/route-registry.ts       (data file — read only)
backend/test-utils/                   (existing utilities — use, don't change)
scripts/smoke-test/                   (D6 work — separate concern)
```

### Key Types & Imports Reference

**ErrorCode enum** (after Task 3 — 18 values):
- New: `METHOD_NOT_ALLOWED` → 405
- Existing: see `backend/shared/types/src/errors.ts`

**InviteCode entity** (after Task 11):
```typescript
interface InviteCode {
  code: string;
  generatedBy: string;     // was: createdBy
  redeemedBy?: string;     // was: usedBy
  redeemedAt?: string;     // was: usedAt
  generatedAt: string;     // was: createdAt
  expiresAt?: string;
}
```

**Frontend ApiClient** (Task 14):
```typescript
// Methods unwrap the { data: T } envelope from ApiSuccessResponse<T> and return T directly.
// On non-2xx, they throw an ApiError with code/message/requestId from the error envelope.
class ApiClient {
  constructor(baseUrl: string, getToken: () => Promise<string | null>);
  get<T>(path: string): Promise<T>;          // unwraps { data: T } → T
  post<T>(path: string, body: unknown): Promise<T>;
  patch<T>(path: string, body: unknown): Promise<T>;
  delete(path: string): Promise<void>;       // 204 No Content
}
```

**Authorizer IAM actions needed** (Task 13):
- `dynamodb:GetItem` — profile lookup, API key lookup
- `dynamodb:PutItem` — ensureProfile (create-on-first-auth)
- `dynamodb:UpdateItem` — lastUsedAt timestamp
- `dynamodb:Query` — GSI lookups (email GSI, API key hash GSI)

### Risks & Mitigations

1. **Task 6 (fail-fast DB config) could break local dev / test setups** — Mitigate by keeping fallbacks when `NODE_ENV=test`. Verify all test suites set the env var or use the test escape hatch.

2. **Task 7 (table name prefix) changes deployed resource names** — This is a breaking change for existing deployments. The prefix defaults to `"dev"` (matching AC10), so existing dev deployments will see table name changes and require a fresh deploy or data migration. Document this explicitly in the PR as a one-time migration step; do NOT add an unprefixed backward-compatibility mode (that defeats the purpose of environment isolation).

3. **Task 11 (InviteCode field rename) could break consumers** — Search comprehensively for all `createdBy`/`usedBy` references on `InviteCode` type. The rename is a compile-time-safe refactor if TypeScript strict mode catches all references.

4. **Task 14 (frontend API client) depends on Clerk SDK** — The frontend already has `@clerk/clerk-react` in package.json (scaffold setup). The `useAuth()` hook is part of Clerk's React SDK.

### References

- [Source: docs/adversarial-architecture-review-2026-02-20.md] — All 15 findings with file paths, line numbers, and fixes
- [Source: docs/# AI Learning Hub — Adversarial Architec_codex.md] — Earlier Codex review (F13-F15 originated here)
- [Source: _bmad-output/implementation-artifacts/2.1-D5-architecture-enforcement-tests.md] — T1-T4 test structure and patterns
- [Source: _bmad-output/planning-artifacts/architecture.md#ADR-008] — Error response format
- [Source: _bmad-output/planning-artifacts/architecture.md#ADR-013] — JWT + API Key auth design
- [Source: _bmad-output/planning-artifacts/architecture.md#ADR-014] — API-first design
- [Source: backend/shared/types/src/errors.ts] — ErrorCode enum, AppError class, ErrorCodeToStatus
- [Source: backend/shared/middleware/src/wrapper.ts] — wrapHandler implementation
- [Source: backend/shared/middleware/src/error-handler.ts] — createErrorResponse, handleError
- [Source: infra/test/architecture-enforcement/] — T1-T4 test suites
- [Source: infra/test/helpers/create-test-api-stacks.ts] — Shared CDK test setup
- [Source: infra/lib/stacks/auth/auth.stack.ts] — Authorizer Lambda definitions + IAM
- [Source: infra/config/route-registry.ts] — Route source of truth
- [Source: docs/progress/story-2.5-review-findings-round-1.md] — Earlier 405 finding (Story 2.5 review)

### Git Intelligence

**Commit message pattern:** `feat: <description> (Story 2.1-D7) #<issue>`
**Branch naming:** `story-2-1-d7-adversarial-review-fixes`

**Suggested commit breakdown** (one per track):
1. `feat: harden T1-T4 handler identity and status code validation (Story 2.1-D7) #<issue>` — Tasks 1, 2
2. `feat: add METHOD_NOT_ALLOWED to ErrorCode, migrate handler 405s (Story 2.1-D7) #<issue>` — Tasks 3, 4
3. `feat: add request-entry logging to wrapHandler (Story 2.1-D7) #<issue>` — Task 5
4. `feat: fail-fast DB config, env-prefix tables, parameterize stage (Story 2.1-D7) #<issue>` — Tasks 6, 7, 8
5. `test: add rate-limit ordering and scope enforcement tests (Story 2.1-D7) #<issue>` — Tasks 9, 10
6. `refactor: align InviteCode types, narrow IAM, remove unused dep (Story 2.1-D7) #<issue>` — Tasks 11, 12, 13
7. `feat: add frontend typed API client and Clerk auth hook (Story 2.1-D7) #<issue>` — Task 14

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
