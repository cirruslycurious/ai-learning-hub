---
id: "2.1-D5"
title: "Architecture Enforcement Tests"
status: done
depends_on: ["2.1-D1", "2.1-D2", "2.1-D3", "2.1-D4"]
touches:
  - infra/test/architecture-enforcement
  - infra/test/helpers
  - backend/test-utils
  - backend/test
  - backend/functions
risk: medium
---

# Story 2.1.D5: Architecture Enforcement Tests

## Story

As a developer (human or AI agent) adding new endpoints in future epics,
I want automated tests that catch missing authorizers, orphan Lambdas, incorrect auth types, ADR-008 violations, and coverage threshold drift,
so that the infrastructure wiring bugs from Epic 2 can never happen again and Epic 3 coding can begin with confidence.

## Acceptance Criteria

1. **AC1 (T1)** — Given the API Gateway stack is synthesized, when T1 runs against the CloudFormation template, then every `AWS::ApiGateway::Method` (except OPTIONS) has `AuthorizationType` != `NONE`.
2. **AC2 (T1)** — Given the API Gateway stack is synthesized, when T1 runs, then Gateway Responses exist for `UNAUTHORIZED`, `ACCESS_DENIED`, `THROTTLED`, `DEFAULT_5XX` with ADR-008 response templates containing `{ "error": { "code", "message", "requestId" } }`.
3. **AC3 (T1)** — Given the API Gateway stack is synthesized, when T1 runs, then every resource has an OPTIONS method (CORS preflight).
4. **AC4 (T1)** — Given the API Gateway stack is synthesized, when T1 runs, then a WAF `CfnWebACLAssociation` exists linking the WebACL to the RestApi stage.
5. **AC5 (T2)** — Given the route registry lists all expected routes, when T2 runs against both the ApiGatewayStack and AuthRoutesStack synthesized templates, then every registry entry has a matching `AWS::ApiGateway::Resource` + `AWS::ApiGateway::Method` in the templates.
6. **AC6 (T2)** — Given a Lambda is defined in any CDK stack, when T2 runs, then every handler Lambda (not authorizer) has at least one API Gateway method integration pointing to it — no orphan Lambdas.
7. **AC7 (T3)** — Given the route registry specifies auth type per route (`jwt`, `jwt-or-apikey`, `iam`, `admin`, `analyst`), when T3 runs, then each route's actual authorizer in the template matches the registry's declared auth type.
8. **AC8 (T3)** — Given a route is accidentally set to `AuthorizationType: NONE`, when T3 runs, then the test fails with message: `"Route {path} {method} has no authorizer but registry requires {authType}"`.
9. **AC9 (T4)** — Given all Lambdas and API Gateway methods are synthesized, when T4 runs, then every `AWS::ApiGateway::Method` `Integration.Uri` resolves to an existing `AWS::Lambda::Function`.
10. **AC10 (T4)** — Given a new Lambda is added without a route, when T4 runs, then the test fails with message: `"Lambda {name} has no API Gateway integration"`.
11. **AC11 (T5)** — A shared test utility `assertADR008Error(response)` exists that asserts `response.body` parses to `{ error: { code, message, requestId } }`, `code` is from the `ErrorCode` enum, and HTTP status matches the `ErrorCodeToStatus` map.
12. **AC12 (T5)** — Every handler test file in `backend/functions/**` includes at least one error path test using `assertADR008Error` to verify ADR-008 compliance.
13. **AC13** — Handler integration tests use `createMockEvent()` with real API Gateway event structure and verify: JWT auth happy path → handler → 200/201 response.
14. **AC14** — Handler integration tests verify: invalid/missing auth → handler → 401 response with ADR-008 shape.
15. **AC15** — Handler integration tests verify: capture-only API key on non-saves endpoint → 403 `SCOPE_INSUFFICIENT`.
16. **AC16** — Handler integration tests verify: rate limit exceeded → 429 with `Retry-After` header.
17. **AC18** — A meta-test scans all vitest configs across the backend workspace and shared packages, asserting every config has coverage thresholds ≥80% (lines, functions, branches, statements). Prevents thresholds from being silently lowered.
18. **AC19** — An extended enforcement test validates that every handler-facing exported function in `@ai-learning-hub/db` accepts an optional `Logger` parameter. Prevents new DB functions from skipping logger support.
19. **AC20** — All T1-T5 tests pass, CDK synth passes, all handler integration tests pass, meta-tests pass, and all existing tests pass. Epic 3 coding may begin.

## Tasks / Subtasks

- [ ] **Task 1: Create infra test helper for CDK stack setup** (AC: all T1-T4)
  - [ ] 1.1 Create `infra/test/helpers/create-test-api-stacks.ts` with shared setup (App, depsStack, WebACL, importFn, ApiGatewayStack, AuthRoutesStack instantiation)
  - [ ] 1.2 Export `{ app, apiGatewayStack, authRoutesStack, apiGwTemplate, routesTemplate }` for consumption by all architecture tests
  - [ ] 1.3 Use the SAME `fromFunctionArn` + `makeArn` pattern from existing `cross-stack-deps.test.ts` (lines 46-49)

- [ ] **Task 2: Implement T1 — API Gateway Contract test** (AC: #1-4)
  - [ ] 2.1 Create `infra/test/architecture-enforcement/api-gateway-contract.test.ts`
  - [ ] 2.2 Test: every non-OPTIONS Method has `AuthorizationType` != `NONE` using `template.findResources("AWS::ApiGateway::Method")` and filtering
  - [ ] 2.3 Test: Gateway Responses exist for 4 response types with ADR-008 body templates
  - [ ] 2.4 Test: every Resource has an OPTIONS method (iterate resources, match methods)
  - [ ] 2.5 Test: `CfnWebACLAssociation` exists with correct RestApi stage ARN

- [ ] **Task 3: Implement T2 — Route Completeness test** (AC: #5-6)
  - [ ] 3.1 Create `infra/test/architecture-enforcement/route-completeness.test.ts`
  - [ ] 3.2 Import `ROUTE_REGISTRY` from `infra/config/route-registry.ts`
  - [ ] 3.3 Test: for each registry entry, a matching Resource path + Method exists in the AuthRoutesStack template
  - [ ] 3.4 Test: no orphan handler Lambdas (every LambdaIntegration URI in methods maps to a function that appears in the registry)

- [ ] **Task 4: Implement T3 — Authorizer Type Correctness test** (AC: #7-8)
  - [ ] 4.1 Create `infra/test/architecture-enforcement/authorizer-type-correctness.test.ts`
  - [ ] 4.2 Extract authorizer logical IDs from the ApiGatewayStack template (jwt authorizer vs api-key authorizer)
  - [ ] 4.3 For each registry route, verify the Method's `AuthorizerId` matches the expected authorizer for the route's `authType`
  - [ ] 4.4 Test negative case: assert clear error message format for missing authorizer

- [ ] **Task 5: Implement T4 — Lambda ↔ Route Wiring test** (AC: #9-10)
  - [ ] 5.1 Create `infra/test/architecture-enforcement/lambda-route-wiring.test.ts`
  - [ ] 5.2 Test: every Method's `Integration.Uri` resolves to a Lambda function (use `Fn::Join` / `Fn::GetAtt` pattern matching)
  - [ ] 5.3 Test: every handler Lambda ARN appears in at least one Method integration (no orphans)

- [ ] **Task 6: Create assertADR008Error utility** (AC: #11)
  - [ ] 6.1 Create `backend/test-utils/assert-adr008.ts`
  - [ ] 6.2 Implement `assertADR008Error(response, expectedCode, expectedStatus?)` — parse body, validate shape, check ErrorCode enum membership, verify status matches ErrorCodeToStatus
  - [ ] 6.3 Export from `backend/test-utils/index.ts` barrel
  - [ ] 6.4 Add unit tests for the utility itself in `backend/test-utils/assert-adr008.test.ts`

- [ ] **Task 7: Add ADR-008 error path tests to all handlers** (AC: #12)
  - [ ] 7.1 Add `assertADR008Error` import to each handler test file
  - [ ] 7.2 Add/verify error path test in: `validate-invite/handler.test.ts` (e.g., invalid invite code → INVALID_INVITE_CODE)
  - [ ] 7.3 Add/verify error path test in: `users-me/handler.test.ts` (e.g., missing body → VALIDATION_ERROR)
  - [ ] 7.4 Add/verify error path test in: `api-keys/handler.test.ts` (e.g., revoke nonexistent → NOT_FOUND)
  - [ ] 7.5 Add/verify error path test in: `invite-codes/handler.test.ts` (e.g., invalid code → INVALID_INVITE_CODE)
  - [ ] 7.6 Add/verify error path test in: `jwt-authorizer/handler.test.ts` (e.g., expired token → UNAUTHORIZED)
  - [ ] 7.7 Add/verify error path test in: `api-key-authorizer/handler.test.ts` (e.g., revoked key → UNAUTHORIZED)

- [ ] **Task 8: Handler integration tests** (AC: #13-16)
  - [ ] 8.1 Use `createMockEvent()` from `backend/test-utils/mock-wrapper.ts` to create realistic API Gateway events
  - [ ] 8.2 Test JWT happy path: valid auth context → 200/201 response
  - [ ] 8.3 Test missing auth: no authorizer context → 401 with ADR-008 shape
  - [ ] 8.4 Test scope insufficient: capture-only API key on write endpoint → 403 SCOPE_INSUFFICIENT
  - [ ] 8.5 Test rate limited: mock `checkRateLimit` to exceed threshold → 429 with Retry-After header

- [ ] **Task 9: Quality Gate Self-Test** (AC: #18)
  - [ ] 9.1 Create `backend/test/quality-gate-self-test.test.ts`
  - [ ] 9.2 Programmatically scan all vitest config files (`backend/vitest.config.ts`, `backend/shared/*/vitest.config.ts`, `infra/vitest.config.ts`)
  - [ ] 9.3 Parse or import each config and assert `coverage.thresholds` has `lines`, `functions`, `branches`, `statements` all ≥80
  - [ ] 9.4 Test fails with clear message if any config is missing thresholds or has thresholds below 80%

- [ ] **Task 10: DB Logger Signature Test** (AC: #19)
  - [ ] 10.1 Create or extend `backend/test/db-logger-signature.test.ts`
  - [ ] 10.2 Import the public API from `@ai-learning-hub/db` barrel export
  - [ ] 10.3 For each handler-facing exported function, verify the last (or last optional) parameter accepts `Logger` type
  - [ ] 10.4 Test fails with clear message identifying any function missing logger support

- [ ] **Task 11: Verify Epic 3 Gate** (AC: #20)
  - [ ] 11.1 Run `npm test` across all workspaces — all tests must pass
  - [ ] 11.2 Run `cdk synth` in `infra/` — must complete without errors
  - [ ] 11.3 Verify all T1-T7 tests pass
  - [ ] 11.4 Verify coverage thresholds met

## Dev Notes

### Critical Learnings from D1-D4 (MUST READ)

**From D1 (API Gateway — 2 rounds, 9+8 findings):**
- ⚠️ **CDK circular dependency trap:** Passing real Lambda constructs between stacks creates implicit `Lambda::Permission` cross-stack references. D1 solved this by passing authorizer Lambdas as ARN strings (`jwtAuthorizerFunctionArn: string`) and using `Function.fromFunctionArn()` inside ApiGatewayStack. **DO NOT import real Lambda IFunction constructs into ApiGatewayStack.**
- ⚠️ **CORS on imported APIs:** `RestApi.fromRestApiAttributes()` does NOT inherit `defaultCorsPreflightOptions`. D1 added explicit `addCorsPreflight()` on every resource in AuthRoutesStack. **All architecture tests must verify OPTIONS methods exist.**
- ⚠️ **Test topology must match real topology:** The cross-stack test initially used `fromFunctionArn` which masked the circular dependency. D1 fixed by also synthesizing real stacks in tests. **T1-T4 tests should use the shared test helper that reproduces the real stack topology.**
- The API Key authorizer currently handles BOTH JWT and API key auth (REQUEST type, no identitySources, caching disabled). This is documented in conventions but the Lambda only checks x-api-key currently.
- Gateway Response error codes MUST match the `ErrorCode` enum from `@ai-learning-hub/types` (UNAUTHORIZED, FORBIDDEN, RATE_LIMITED, INTERNAL_ERROR).

**From D3 (Mock Dedup — 0 critical, 3 important):**
- `scopes` was silently dropped in `createMockEvent` initially. Fixed: scopes are now plumbed into `event.requestContext.authorizer.scopes` and parsed in mock `wrapHandler`.
- `MockLogger` and `MockMiddlewareModule` types are exported from barrel.
- `mockMiddlewareModule()` supports `extraExports` for Clerk integration mocks.

**From D4 (Logger — 0 critical, 3 important):**
- Positional optional parameters are a minor anti-pattern. `createInviteCode(client, userId, undefined, logger)` works but is fragile.
- Handler tests use `expect.anything()` for logger — weak verification. D5 can strengthen this if needed.
- DB-level unit tests do NOT exercise the logger parameter. Consider adding assertion in the DB Logger Signature Test.

### Architecture Patterns to Follow

**CDK Template Assertions (use in T1-T4):**
```typescript
import { Template, Match } from "aws-cdk-lib/assertions";

// Find all resources of a type
const methods = template.findResources("AWS::ApiGateway::Method");
// Assert specific resource properties
template.hasResourceProperties("AWS::ApiGateway::Method", {
  AuthorizationType: "CUSTOM",
});
// Count resources
template.resourceCountIs("AWS::ApiGateway::RestApi", 1);
// Check outputs
template.hasOutput("RestApiId", { Export: { Name: "..." } });
```

**Route Registry Import (use in T2-T3):**
```typescript
import { ROUTE_REGISTRY, type RouteEntry, type AuthType } from "../../../config/route-registry";
```

**T6 Pattern (file-scanning enforcement, use for quality gate + DB logger tests):**
```typescript
// Scan files, build violations list, fail with clear messages
const violations: Violation[] = [];
// ... scan logic
if (violations.length > 0) {
  expect.fail(`Violation found:\n${messages.join("\n")}`);
}
```

**ADR-008 Error Shape (use in assertADR008Error):**
```typescript
import { ErrorCode, ErrorCodeToStatus } from "@ai-learning-hub/types";
// Response body must parse to:
interface ExpectedError {
  error: {
    code: string;    // Must be a valid ErrorCode enum value
    message: string; // Non-empty
    requestId: string; // Non-empty
    details?: Record<string, unknown>; // Optional
  }
}
// And: ErrorCodeToStatus[code] === response.statusCode
```

**Shared Test Setup Pattern (from cross-stack-deps.test.ts):**
```typescript
const app = new App();
const awsEnv = getAwsEnv();
const depsStack = new Stack(app, "TestDeps", { env: awsEnv });
const webAcl = new wafv2.CfnWebACL(depsStack, "TestWebAcl", { ... });
const makeArn = (name: string) => `arn:aws:lambda:${testRegion}:${testAccount}:function:${name}`;
const importFn = (stack: Stack, name: string) => lambda.Function.fromFunctionArn(stack, name, makeArn(name));
```

### Project Structure Notes

**Files to create:**
```
infra/test/
  ├── architecture-enforcement/
  │   ├── api-gateway-contract.test.ts       (T1 — AC1-4)
  │   ├── route-completeness.test.ts         (T2 — AC5-6)
  │   ├── authorizer-type-correctness.test.ts (T3 — AC7-8)
  │   └── lambda-route-wiring.test.ts        (T4 — AC9-10)
  └── helpers/
      └── create-test-api-stacks.ts          (shared CDK test setup)

backend/
  ├── test-utils/
  │   ├── assert-adr008.ts                   (T5 utility — AC11)
  │   └── assert-adr008.test.ts              (T5 utility tests)
  └── test/
      ├── quality-gate-self-test.test.ts     (AC18)
      └── db-logger-signature.test.ts        (AC19)
```

**Files to modify:**
```
backend/test-utils/index.ts                  (add assert-adr008 export)
backend/functions/validate-invite/handler.test.ts   (add ADR-008 error test)
backend/functions/users-me/handler.test.ts          (add ADR-008 error test)
backend/functions/api-keys/handler.test.ts          (add ADR-008 error test)
backend/functions/invite-codes/handler.test.ts      (add ADR-008 error test)
backend/functions/jwt-authorizer/handler.test.ts    (add ADR-008 error test)
backend/functions/api-key-authorizer/handler.test.ts (add ADR-008 error test)
```

**Files that MUST NOT be modified:**
```
infra/lib/stacks/api/api-gateway.stack.ts    (production stack — test only)
infra/lib/stacks/api/auth-routes.stack.ts    (production stack — test only)
infra/config/route-registry.ts               (data file — read only in tests)
backend/shared/types/src/errors.ts           (import only)
backend/shared/middleware/src/error-handler.ts (import only)
```

### Key Types & Imports Reference

**ErrorCode enum** (22 values) — `@ai-learning-hub/types`:
- Client: `VALIDATION_ERROR`, `UNAUTHORIZED`, `FORBIDDEN`, `NOT_FOUND`, `CONFLICT`, `DUPLICATE_SAVE`, `RATE_LIMITED`
- Auth: `EXPIRED_TOKEN`, `INVALID_API_KEY`, `REVOKED_API_KEY`, `SUSPENDED_ACCOUNT`, `SCOPE_INSUFFICIENT`, `INVITE_REQUIRED`, `INVALID_INVITE_CODE`
- Server: `INTERNAL_ERROR`, `SERVICE_UNAVAILABLE`, `EXTERNAL_SERVICE_ERROR`

**ErrorCodeToStatus mapping** — `@ai-learning-hub/types`:
- 400: VALIDATION_ERROR, INVALID_INVITE_CODE
- 401: UNAUTHORIZED, EXPIRED_TOKEN, INVALID_API_KEY, REVOKED_API_KEY
- 403: FORBIDDEN, SUSPENDED_ACCOUNT, SCOPE_INSUFFICIENT, INVITE_REQUIRED
- 404: NOT_FOUND
- 409: CONFLICT, DUPLICATE_SAVE
- 429: RATE_LIMITED
- 500: INTERNAL_ERROR
- 502: EXTERNAL_SERVICE_ERROR
- 503: SERVICE_UNAVAILABLE

**Route Registry** — `infra/config/route-registry.ts`:
- 5 routes for Epic 2 (all auth/users domain)
- `AuthType`: `"jwt"` | `"jwt-or-apikey"` | `"iam"` | `"admin"` | `"analyst"`
- `HandlerRef`: `"validateInviteFunction"` | `"usersMeFunction"` | `"apiKeysFunction"` | `"generateInviteFunction"`

**Mock test utilities** — `backend/test-utils/`:
- `createMockEvent({ method, path, body, userId, role, authMethod, scopes, pathParameters, queryStringParameters })`
- `createMockContext()`
- `createMockLogger()` → returns `MockLogger` with vi.fn() stubs
- `mockCreateLoggerModule()` → module factory for vi.mock
- `mockMiddlewareModule({ extraExports? })` → full wrapHandler mock with auth/scope/error handling

**CDK Stack Props:**
- `ApiGatewayStack`: `{ jwtAuthorizerFunctionArn: string, apiKeyAuthorizerFunctionArn: string, webAcl: CfnWebACL }`
- `AuthRoutesStack`: `{ restApiId: string, rootResourceId: string, jwtAuthorizer: IAuthorizer, apiKeyAuthorizer: IAuthorizer, validateInviteFunction: IFunction, usersMeFunction: IFunction, apiKeysFunction: IFunction, generateInviteFunction: IFunction }`

**Vitest config paths to scan for quality gate (AC18):**
- `backend/vitest.config.ts`
- `backend/shared/db/vitest.config.ts`
- `backend/shared/logging/vitest.config.ts`
- `backend/shared/middleware/vitest.config.ts`
- `backend/shared/validation/vitest.config.ts`
- `backend/shared/types/vitest.config.ts`
- `infra/vitest.config.ts`

### References

- [Source: docs/progress/epic-2.1-debt-stories-and-plan.md#Story 2.1-D5] — Epic plan with all 20 ACs
- [Source: _bmad-output/planning-artifacts/architecture.md#ADR-008] — Error response format
- [Source: _bmad-output/planning-artifacts/architecture.md#ADR-013] — JWT + API Key auth
- [Source: _bmad-output/planning-artifacts/architecture.md#ADR-014] — API-first design
- [Source: .claude/docs/api-gateway-conventions.md] — CDK extensibility, auth domains, response format
- [Source: infra/config/route-registry.ts] — Canonical route source of truth
- [Source: backend/shared/types/src/errors.ts] — ErrorCode enum + AppError class
- [Source: backend/shared/middleware/src/error-handler.ts] — createErrorResponse, handleError
- [Source: backend/test-utils/mock-wrapper.ts] — Shared mock utilities
- [Source: infra/test/stacks/api/cross-stack-deps.test.ts] — T7 CDK test patterns
- [Source: backend/test/import-enforcement.test.ts] — T6 file-scanning enforcement pattern
- [Source: docs/progress/story-2.1-D1-review-findings-round-1.md] — D1 critical learnings (circular deps, CORS)
- [Source: docs/progress/story-2.1-D1-review-findings-round-2.md] — D1 round 2 (authorizer ARN fix)
- [Source: docs/progress/story-2.1-D3-review-findings-round-1.md] — D3 scopes plumbing fix
- [Source: docs/progress/story-2.1-D4-review-findings-round-1.md] — D4 logger parameter patterns

### Git Intelligence

**Recent commit patterns (last 5):**
- `feat: Save Validation & Content Detection Modules (Story 3.1a) (#156)` — Epic 3 has started
- `feat: auto-epic orchestrator improvements (Groups 1-4) (#154)` — Tooling improvements
- `feat: add API Gateway stack, auth routes, conventions doc, and route registry (Story 2.1-D1) (#153)` — D1 completed
- `feat: add request-scoped logger to DB layer functions (Story 2.1-D4) #150` — D4 completed
- `feat: extract shared wrapHandler test mock utility (Story 2.1-D3) #148` — D3 completed

**Commit message pattern:** `feat: <description> (Story X.Y-DN) #issue`
**Branch naming pattern:** `story-2-1-dN-<kebab-description>`

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
