# Epic 2 Retrospective: User Authentication & API Keys

**Date:** 2026-02-16
**Epic:** 2
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Stephen

---

## Executive Summary

Epic 2 delivered a complete authentication and API key system across 9 stories in approximately 2 days. All stories passed code review (4 required Round 2), with 7 critical findings caught by the review process — including 3 release-blockers. The retrospective identified a significant infrastructure gap: no API Gateway REST API exists, meaning all Epic 2 endpoints are uncallable in a deployed environment. Stephen directed the creation of Epic 2.1 (Debt) to address this and other technical debt before Epic 3 begins.

---

## Epic 2 Summary

### Delivery Metrics

| Metric | Value |
|--------|-------|
| **Completed Stories** | 9/9 (100%) |
| **Duration** | ~2 days (Feb 14–16, 2026) |
| **Test Count** | 706 tests passing at completion |
| **Review Rounds** | 13 total (4 stories needed Round 2: 2.1, 2.2, 2.6, 2.7) |
| **Critical Review Findings** | 7 across all reviews (all fixed) |
| **Technical Debt Items** | 6 documented |
| **Production Incidents** | 0 |

### Stories Delivered

| Story | Title | PRs | Review Rounds | Notes |
|-------|-------|-----|---------------|-------|
| 2.1 | Clerk Integration + JWT Authorizer | #123 | 1 (14 findings, 2 critical) | SSM SecureString fix, performance fast-path fix |
| 2.2 | API Key Authorizer | #126 | 2 (Round 1: 10 findings, 1 critical; Round 2: 9 findings, 2 critical) | Missing barrel exports + CDK stack caught in Round 2 |
| 2.3 | Scope Middleware | #128 | 1 | Clean pass |
| 2.4 | Invite Validation Endpoint | #132 | 1 | Clean pass |
| 2.5 | User Profile | #134 | 1 | Clean pass |
| 2.6 | API Key CRUD | #136 | 2 (Round 1: 10 findings, 2 critical; Round 2: 6 findings, 0 critical) | Missing 201 status, untracked files caught in Round 2 |
| 2.7 | Rate Limiting | #138 | 2 (Round 1: 12 findings, 2 critical; Round 2: 3 findings, 0 critical) | DynamoDB TTL + Retry-After header fixed |
| 2.8 | Auth Error Codes | #141 | 1 | Error code consolidation |
| 2.9 | Invite Code Generation | #143 | 1 (PASS_WITH_NOTES) | 100% handler coverage, 706 tests |

---

## What Went Well

### 1. Code Review Process as Safety Net
- 7 critical findings caught by adversarial code review — including 3 release-blockers
- No critical issue escaped to production
- Round 2 reviews showed dramatic improvement (e.g., 2.7: 2 critical → 0 critical)
- Review process matured across the epic — later stories (2.8, 2.9) passed in 1 round

### 2. Shared Library Architecture
- `@ai-learning-hub/middleware` expanded with `authorizer-policy.ts` (extracted from duplicated code)
- Error code system (`ErrorCode` enum + `ErrorCodeToStatus` map) provides systematic error handling
- Rate limiter in `@ai-learning-hub/db` is reusable across all future endpoints
- Shared `paginationQuerySchema` and `apiKeyScopesSchema` in `@ai-learning-hub/validation`

### 3. Exceptional Velocity
- 9 stories in ~2 days
- Test count grew to 706
- Story 2.9 achieved 100% handler coverage
- Improvement trajectory visible: later stories required fewer review rounds

### 4. Deliberate Scope Management
- AC5 rate limiting deferred from Story 2.6 to 2.7 (documented, not forgotten)
- Gateway Responses explicitly documented as deferred until API Gateway exists
- `lastUsedAt` fire-and-forget trade-off documented

### 5. Architecture Patterns Established
- Two-query authorizer pattern (GSI lookup + profile fetch)
- DynamoDB atomic counter pattern for rate limiting with TTL cleanup
- ADR-008 error response formatting via shared middleware
- `deny()` vs `throw` authorizer error paths clearly documented

---

## Challenges and Growth Areas

### 1. Implementation Outpaced Infrastructure Wiring
- **Pattern:** Dev agent builds correct logic but misses CDK stacks, barrel exports, git operations
- **Examples:** 2.2 missing CDK Lambda definition + missing barrel exports; 2.6 handler files never git-added
- **Root cause:** Focus on "does the code work?" without verifying "is it deployable?"
- **Impact:** 3 release-blocking findings that would have shipped broken code

### 2. REST Convention Violations
- **Pattern:** POST returning 200 instead of 201, DELETE returning 200 instead of 204
- **Examples:** Story 2.6 (both violations)
- **Root cause:** Dev agent defaults to 200 unless explicitly reminded

### 3. Infrastructure Gaps Discovered Late
- **Pattern:** Critical infrastructure (SSM SecureString, DynamoDB TTL, Retry-After header) missed during implementation, caught in review
- **Examples:** 2.1 plaintext SSM secret, 2.7 TTL not enabled, 2.7 Retry-After as body-only
- **Root cause:** Infrastructure concerns treated as secondary to business logic

### 4. API Gateway Never Created
- **The single biggest finding of this retrospective:** All 6 Epic 2 handler Lambdas exist but there is no API Gateway REST API to route HTTP requests to them
- **Impact:** Zero Epic 2 endpoints are callable in a deployed environment
- **Root cause:** Each story focused on its Lambda; no story owned the API Gateway creation
- **Resolution:** Epic 2.1 (Debt) — D1 task

---

## Key Insights

1. **Code review is the most valuable quality gate** — More valuable than tests alone. Tests verify logic; reviews catch wiring, infrastructure, security, and convention issues.

2. **"Rooms without a front door"** — Implementation quality is high, but deployment infrastructure lagged. The API Gateway gap is the starkest example.

3. **Technical debt compounds at epic boundaries** — Logger context, test mock duplication, and coverage thresholds were all flagged during Epic 2 but deferred. Paying this debt between epics (Epic 2.1) prevents compound interest.

4. **Pattern quality matters more than speed** — Stephen's decision to create an extensible API Gateway pattern rather than a quick-fix benefits all 9 remaining epics.

5. **Improvement trajectory is real** — Stories 2.8 and 2.9 passed in 1 round. 2.9 achieved PASS_WITH_NOTES with 100% coverage. The team learns from earlier reviews.

---

## Previous Retrospective Follow-Through (Epic 1)

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | Update sprint-status for Story 1.13 | ✅ Completed | Sprint-status shows 1-13 as done |
| 2 | Add documentation checklist to story template for doc-only stories | ⏳ Not tested | Epic 2 had no doc-only stories |
| 3 | Align sprint-status "review" → "done" with PR merge workflow | ⏳ Partial | Story 2.8 file still says "Status: review" |
| 4 | Verify Epic 2 prerequisites (Clerk, users table schema) before kickoff | ✅ Completed | Epic 2 delivered successfully |

**Lessons applied from Epic 1:**
- ✅ Shared library enforcement continued (review caught duplication in 2.2, led to authorizer-policy.ts extraction)
- ✅ CI quality gates caught issues consistently
- ⏳ Status alignment still needs attention (same issue as Epic 1)

---

## Significant Discovery: API Gateway Gap

### Discovery

During Epic 2 retrospective analysis, the team discovered that **no API Gateway REST API resource exists in the CDK codebase**. All 6 Epic 2 handler Lambdas (validate-invite, users-me, api-keys, invite-codes + 2 authorizers) are deployed but unreachable via HTTP.

### Impact on Epic 3

Epic 3's first API story (3.1b: Create Save API) requires `POST /saves` — an endpoint that needs an API Gateway. Without addressing this gap, Epic 3 cannot begin.

### Resolution: Epic 2.1 (Debt)

Stephen directed the creation of Epic 2.1 to address this and other technical debt before Epic 3 starts. See Action Items below.

---

## Action Items: Epic 2.1 (Debt)

| # | Task | Description | Owner | Priority | Dependencies |
|---|------|-------------|-------|----------|--------------|
| **D1** | API Gateway REST API Stack | Create CDK stack: RestApi, routes for all Epic 2 endpoints, JWT + API Key authorizer wiring, Gateway Responses for ADR-008 error formatting, WAF association, stage throttling, CORS, extensible pattern for future epics | Dev + Architect | Critical | D4 (logger) |
| **D2** | Backend Coverage Thresholds | Set `backend/vitest.config.ts` thresholds to 80% (lines, functions, branches, statements). Fix any handlers below threshold. | Dev | High | None |
| **D3** | wrapHandler Test Mock Dedup | Extract ~100-line wrapHandler mock into shared `backend/test-utils/mock-wrapper.ts`. Update all handler test files to import from shared location. | Dev | High | None |
| **D4** | Request-Scoped Logger in DB Layer | Add optional `logger` parameter to all DB functions (~15 functions). Pass request-scoped logger (with requestId, traceId) from handlers. Update tests. | Dev | High | None |
| **D5** | E2E Integration Test | Verify full HTTP chain: API Gateway → Authorizer → Lambda → DynamoDB → ADR-008 response. Cover: JWT auth, API key auth, scope enforcement, rate limiting (429 + Retry-After), auth error codes, requestId correlation across handler + DB logs. | QA + Dev | Critical | D1, D2, D3, D4 |

### Dependency Order

```
D2 (Coverage thresholds) ──────────┐
D3 (wrapHandler mock dedup) ───────┼──► D1 (API Gateway stack) ──► D5 (E2E test)
D4 (Logger request-scoped) ────────┘
```

D2, D3, D4 can run in parallel. D1 after D4 (so API Gateway handlers use request-scoped logging). D5 last (validates everything).

---

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| **Testing & Quality** | ⚠️ Needs D2, D5 | 706 tests pass; coverage thresholds ungated; no E2E tests |
| **Deployment** | ⚠️ Needs D1 | Lambdas deployed, no API Gateway |
| **Stakeholder Acceptance** | ✅ N/A | Auth epic; no external stakeholders |
| **Technical Health** | ⚠️ Needs D3, D4 | Code is clean; test mocks duplicated; logging gap |
| **Unresolved Blockers** | 1 | API Gateway (D1) blocks all endpoint access |

---

## Next Steps

1. **Execute Epic 2.1 (Debt)** — All 5 tasks must complete before Epic 3
2. **D5 (E2E test) is the gate** — Epic 3 cannot start until D5 passes
3. **Epic 3: Save URLs (Core CRUD)** — 11 stories, first epic with frontend work
4. **Apply lessons from Epic 2** — Verify CDK wiring, barrel exports, git status in every story

---

## Retrospective Closure

Epic 2 delivered a complete authentication system with exceptional velocity (9 stories, ~2 days, 706 tests). The code review process proved its value by catching 7 critical findings including 3 release-blockers. The most significant discovery — the missing API Gateway — led to the creation of Epic 2.1 (Debt), ensuring Epic 3 starts on a solid, proven foundation.

**Commitments:** 5 Epic 2.1 tasks, E2E verification gate before Epic 3.

**Team performance:** Strong implementation quality, improving review pass rates, decisive leadership on debt management.

---

*Generated by BMAD BMM Retrospective workflow. Epic 2 retrospective marked complete in sprint-status.yaml.*
